generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                    @id
  full_name                String
  email                    String                    @unique
  role                     String
  avatar_url               String?
  is_active                Boolean                   @default(true)
  created_at               DateTime                  @default(now())
  updated_at               DateTime                  @updatedAt
  purchases                String[]                  @default([])
  Assignments              Assignment[]
  ClassesCreated           Class[]                   @relation("CreatedClasses")
  ClassMembers             ClassMember[]
  ClassTeachers            ClassTeacher[]
  ConversationParticipants ConversationParticipant[]
  Messages                 Message[]
  SessionHosted            Session[]
  SessionAttendances       SessionAttendance[]
  StudentProfile           StudentProfile?
  TeacherProfile           TeacherProfile?
  ConversationsCreated     Conversation[]            @relation("ConversationCreatedBy")
  ConversationsOwned       Conversation[]            @relation("ConversationOwner")
}

model StudentProfile {
  user_id       String @id
  target_score  Int
  current_level String
  user          User   @relation(fields: [user_id], references: [id])
}

model TeacherProfile {
  user_id        String @id
  degree         String
  specialization String
  bio            String
  user           User   @relation(fields: [user_id], references: [id])
}

model Class {
  id            String         @id @default(uuid())
  name          String         @unique
  slug          String         @unique
  description   String
  is_group      Boolean
  invite_code   String         @unique
   /// Price in Vietnamese đồng (VND). Null means the class is free.
  price         Int?
  currency      String         @default("vnd")
  schedule      Json
  created_by    String
  created_at    DateTime       @default(now())
  updated_at    DateTime       @updatedAt
  assignments   Assignment[]
  creator       User           @relation("CreatedClasses", fields: [created_by], references: [id])
  members       ClassMember[]
  teachers      ClassTeacher[]
  messages      Message[]
  sessions      Session[]
  conversations Conversation[]
}

model ClassMember {
  id         String   @id @default(uuid())
  class_id   String
  student_id String
  joined_at  DateTime @default(now())
  status     String
  class      Class    @relation(fields: [class_id], references: [id])
  student    User     @relation(fields: [student_id], references: [id])

  @@index([class_id, student_id])
}

model ClassTeacher {
  id         String @id @default(uuid())
  class_id   String
  teacher_id String
  role       String
  class      Class  @relation(fields: [class_id], references: [id])
  teacher    User   @relation(fields: [teacher_id], references: [id])

  @@index([class_id, teacher_id])
}

model Session {
  id              String              @id @default(uuid())
  class_id        String
  host_id         String
  start_time      DateTime
  end_time        DateTime?
  is_recorded     Boolean
  recording_url   String?
  whiteboard_data Json?
  metadata        Json?
  created_at      DateTime            @default(now())
  messages        Message[]
  attendances     SessionAttendance[]
  class           Class               @relation(fields: [class_id], references: [id])
  host            User                @relation(fields: [host_id], references: [id])

  @@index([class_id, start_time])
  @@index([host_id, start_time])
}

model Assignment {
  id          String   @id @default(uuid())
  created_by  String
  class_id    String?
  skill       String
  title       String
  slug        String   @unique
  description String
  is_public   Boolean
  created_at  DateTime @default(now())
  class       Class?   @relation(fields: [class_id], references: [id])
  creator     User     @relation(fields: [created_by], references: [id])
}

model Conversation {
  id            String                    @id @default(uuid())
  isGroup       Boolean                   @default(false)
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  title         String?
  createdBy     String
  ownerId       String?
  isDeleted     Boolean                   @default(false)
  classId       String?
  participants  ConversationParticipant[]
  messages      Message[]
  createdByUser User                      @relation("ConversationCreatedBy", fields: [createdBy], references: [id])
  owner         User?                     @relation("ConversationOwner", fields: [ownerId], references: [id])
  class         Class?                    @relation(fields: [classId], references: [id])

  @@unique([classId])
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  userId         String
  conversationId String
  joinedAt       DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@unique([userId, conversationId])
  @@index([conversationId, userId])
}

model Message {
  id             String        @id @default(uuid())
  content        String
  type           MessageType   @default(DIRECT)
  sentAt         DateTime      @default(now())
  senderId       String
  conversationId String?
  classId        String?
  sessionId      String?
  replyToId      String?
  attachments    Json?
  class          Class?        @relation(fields: [classId], references: [id])
  conversation   Conversation? @relation(fields: [conversationId], references: [id])
  sender         User          @relation(fields: [senderId], references: [id])
  session        Session?      @relation(fields: [sessionId], references: [id])
  replyTo        Message?      @relation("MessageReplies", fields: [replyToId], references: [id])
  replies        Message[]     @relation("MessageReplies")

  @@index([conversationId, sentAt])
}

enum MessageType {
  DIRECT
  CLASSROOM
  MEETING
}

model SessionAttendance {
  id               String    @id @default(uuid())
  session_id       String
  user_id          String
  joined_at        DateTime  @default(now())
  left_at          DateTime?
  duration_seconds Int?
  is_attended      Boolean   @default(false)
  attended_at      DateTime?
  session          Session   @relation(fields: [session_id], references: [id], onDelete: Cascade)
  user             User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([session_id, user_id])
  @@index([session_id])
  @@index([user_id])
}
